{% extends "base.html" %}

{% block title %}TEAM10X - Medical Documents{% endblock %}

{% block nav_title %}Medical Documents{% endblock %}

{% block page_navigation %}
<a href="{{ url_for('documents') }}{% if current_user.role == 'medecin' %}?patient_id={{ request.args.get('patient_id') }}{% endif %}" class="active" id="documents-nav-link">
    <i class="fas fa-file-medical"></i>
    Documents
</a>
<a href="{{ url_for('prescriptions') }}{% if current_user.role == 'medecin' %}?patient_id={{ request.args.get('patient_id') }}{% endif %}" id="prescriptions-nav-link">
    <i class="fas fa-prescription"></i>
    Prescriptions
</a>
<a href="{{ url_for('summarizer') }}{% if current_user.role == 'medecin' %}?patient_id={{ request.args.get('patient_id') }}{% endif %}" id="summarizer-nav-link">
    <i class="fas fa-book-medical"></i>
    Summarizer
</a>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const links = ['documents-nav-link', 'prescriptions-nav-link', 'summarizer-nav-link'];
        const patientId = localStorage.getItem('selectedPatientId');
        if (patientId) {
            links.forEach(linkId => {
                const link = document.getElementById(linkId);
                const url = new URL(link.href);
                url.searchParams.delete('patient_id');
                url.searchParams.set('patient_id', patientId);
                link.href = url.toString();
            });
        }
    });
</script>
{% endblock %}

{% block content %}
<div id="documentsList" class="documents-list">
    <div class="documents-header">
        <h2>Medical Documents</h2>
        {% if current_user.role == 'medecin' %}
        <button id="uploadButton" class="btn-primary" onclick="showUploadZone()" disabled>
            <i class="fas fa-upload"></i> Upload Document
        </button>
        {% endif %}
    </div>
    <!-- Documents will be loaded here -->
</div>

<div class="drop-zone" id="dropZone" style="display: none;">
    <p>Drag & Drop your medical document (PDF) here</p>
    <p>or</p>
    <p>Click to select file</p>
    <input type="file" id="fileInput" accept=".pdf" style="display: none">
</div>

<div class="loader" id="loader"></div>
<div id="results"></div>

<style>
.documents-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.documents-header button {
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.documents-header button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.drop-zone {
    width: auto;
    display: none;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    margin: 2rem 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.drop-zone.dragover {
    border-color: var(--primary-color);
    background-color: rgba(var(--primary-color-rgb), 0.1);
}
</style>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const loader = document.getElementById('loader');
    const results = document.getElementById('results');

    // Handle drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('dragover');
    }

    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }

    dropZone.addEventListener('drop', handleDrop, false);
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        handleFile(file);
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        handleFile(file);
    }

    function loadDocuments() {
        // Get patient_id from localStorage if we're a doctor
        const patientId = {% if current_user.role == 'medecin' %}localStorage.getItem('selectedPatientId'){% else %}null{% endif %};
        
        // Construct the URL with patient_id if needed
        const url = '/api/documents' + (patientId ? `?patient_id=${patientId}` : '');
        
        fetch(url)
            .then(response => response.json())
            .then(documents => {
                const documentsList = document.getElementById('documentsList');
                if (documents.length === 0) {
                    documentsList.innerHTML = '<h2>Uploaded Documents</h2><p>No documents uploaded yet.</p>';
                    return;
                }

                // Calculate total pages across all documents
                const totalPages = documents.reduce((sum, doc) => sum + doc.total_pages, 0);
                let html = `<h2>Uploaded Documents (${documents.length} documents)</h2>`;
                
                documents.forEach(doc => {
                    const uploadDate = new Date(doc.upload_date).toLocaleString();
                    html += `
                        <div class="document-item" id="doc-${doc.id}">
                            <div>
                                <strong>${doc.filename}</strong>
                                <br>
                                <small>Uploaded: ${uploadDate}</small>
                                <br>
                                <small>Total Pages: ${doc.total_pages}</small>
                            </div>
                            <div>
                                <button onclick="viewDocument(${doc.id})">View</button>
                                <button onclick="deleteDocument(${doc.id})" class="delete-btn">Delete</button>
                            </div>
                        </div>
                    `;
                });
                documentsList.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                const documentsList = document.getElementById('documentsList');
                documentsList.innerHTML = '<h2>Uploaded Documents</h2><p style="color: red">Error loading documents.</p>';
            });
    }

    function viewDocument(docId) {
        const patientId = {% if current_user.role == 'medecin' %}localStorage.getItem('selectedPatientId'){% else %}null{% endif %};
        const url = `/api/documents/${docId}` + (patientId ? `?patient_id=${patientId}` : '');
        
        loader.style.display = 'block';
        results.style.display = 'none';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let html = `<h2>Document: ${data.filename}</h2>`;
                
                // Sort pages by page number
                const sortedPages = data.pages.sort((a, b) => a.page_number - b.page_number);
                
                sortedPages.forEach(page => {
                    html += `
                        <div class="page">
                            <div class="page-header">Page ${page.page_number}</div>
                            <div class="page-container">
                                ${page.image_data ? 
                                    `<div>
                                        <img src="data:image/png;base64,${page.image_data}" 
                                            alt="Page ${page.page_number}" 
                                            class="page-image">
                                    </div>` : 
                                    '<div><p>No image available for this page</p></div>'
                                }
                                <div class="page-content">${page.content}</div>
                            </div>
                        </div>
                    `;
                });
                
                loader.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = html;
            })
            .catch(error => {
                loader.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = `<p style="color: red">Error loading document: ${error.message}</p>`;
            });
    }

    function deleteDocument(docId) {
        if (!confirm('Are you sure you want to delete this document?')) {
            return;
        }

        const patientId = {% if current_user.role == 'medecin' %}localStorage.getItem('selectedPatientId'){% else %}null{% endif %};
        const url = `/api/documents/${docId}` + (patientId ? `?patient_id=${patientId}` : '');

        fetch(url, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(() => {
                document.getElementById(`doc-${docId}`).remove();
                if (document.querySelectorAll('.document-item').length === 0) {
                    document.getElementById('documentsList').innerHTML = '<h2>Uploaded Documents</h2><p>No documents uploaded yet.</p>';
                }
            })
            .catch(error => {
                console.error('Error deleting document:', error);
                alert('Error deleting document');
            });
    }

    function handleFile(file) {
        if (!file.type.includes('pdf')) {
            alert('Please upload a PDF file');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        
        // Add patient_id to formData if we're a doctor
        {% if current_user.role == 'medecin' %}
        const patientId = localStorage.getItem('selectedPatientId');
        if (patientId) {
            formData.append('patient_id', patientId);
        }
        {% endif %}

        loader.style.display = 'block';
        results.style.display = 'none';
        
        // Add timeout of 5 minutes (300000ms)
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 300000);

        fetch('/api/process-pdf', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        })
        .then(response => {
            if (!response.ok) {
                loader.style.display = 'none';
                results.style.display = 'block';
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            clearTimeout(timeout);
            loader.style.display = 'none';
            results.style.display = 'block';
            
            if (data.error) {
                results.innerHTML = `<p style="color: red">Error: ${data.error}</p>`;
                return;
            }

            let html = `<h2>Extracted Content (${data.total_pages} pages)</h2>`;
            data.results.forEach(result => {
                html += `
                    <div class="page">
                        <div class="page-header">Page ${result.page_number}</div>
                        <div class="page-container">
                            ${result.image_data ? 
                                `<div>
                                    <img src="data:image/png;base64,${result.image_data}" 
                                        alt="Page ${result.page_number}" 
                                        class="page-image">
                                </div>` : 
                                '<div><p>No image available for this page</p></div>'
                            }
                            <div class="page-content">${result.content}</div>
                        </div>
                    </div>
                `;
            });
            results.innerHTML = html;
            
            // Reload the documents list after successful upload
            loadDocuments();
        })
        .catch(error => {
            clearTimeout(timeout);
            loader.style.display = 'none';
            results.style.display = 'block';
            if (error.name === 'AbortError') {
                results.innerHTML = `<p style="color: red">Error: Upload timed out after 5 minutes. Please try again with a smaller file or check your connection.</p>`;
            } else {
                results.innerHTML = `<p style="color: red">Error: ${error.message}</p>`;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        {% if current_user.role == 'medecin' %}
        // Enable/disable upload button based on patient selection
        const uploadButton = document.getElementById('uploadButton');
        const dropZone = document.getElementById('dropZone');
        const patientSelect = document.getElementById('navPatientSelect');
        
        if (patientSelect) {
            patientSelect.addEventListener('change', function() {
                const selectedPatientId = this.value;
                uploadButton.disabled = !selectedPatientId;
                dropZone.style.display = 'block';
            });
            
            // Check initial state
            const savedPatientId = localStorage.getItem('selectedPatientId');
            uploadButton.disabled = !savedPatientId;
            dropZone.style.display = 'block';
        }
        {% endif %}
        
        // Load documents list
        loadDocuments();
    });

    function showUploadZone() {
        const dropZone = document.getElementById('dropZone');
        dropZone.style.display = dropZone.style.display === 'none' ? 'block' : 'none';
        if (dropZone.style.display === 'block') {
            dropZone.scrollIntoView({ behavior: 'smooth' });
        }
    }
</script>
{% endblock %}
