{% extends "base.html" %}

{% block title %}TEAM10X - Document Manager{% endblock %}

{% block nav_title %}Document Manager{% endblock %}

{% block content %}
<div id="documentsList" class="documents-list">
    <h2>Medical Documents</h2>
    <!-- Documents will be loaded here -->
</div>

<div class="drop-zone" id="dropZone">
    <p>Drag & Drop your medical document (PDF) here</p>
    <p>or</p>
    <p>Click to select file</p>
    <input type="file" id="fileInput" accept=".pdf" style="display: none">
</div>

<div class="loader" id="loader"></div>
<div id="results"></div>
{% endblock %}

{% block scripts %}
<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const loader = document.getElementById('loader');
    const results = document.getElementById('results');

    // Handle drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('dragover');
    }

    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }

    dropZone.addEventListener('drop', handleDrop, false);
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        handleFile(file);
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        handleFile(file);
    }

    function loadDocuments() {
        fetch('/api/documents')
            .then(response => response.json())
            .then(documents => {
                const documentsList = document.getElementById('documentsList');
                if (documents.length === 0) {
                    documentsList.innerHTML = '<h2>Uploaded Documents</h2><p>No documents uploaded yet.</p>';
                    return;
                }

                let html = '<h2>Uploaded Documents</h2>';
                documents.forEach(doc => {
                    const uploadDate = new Date(doc.upload_date).toLocaleString();
                    html += `
                        <div class="document-item" id="doc-${doc.id}">
                            <div>
                                <strong>${doc.filename}</strong>
                                <br>
                                <small>Uploaded: ${uploadDate} - ${doc.total_pages} pages</small>
                            </div>
                            <div>
                                <button onclick="viewDocument(${doc.id})">View</button>
                                <button onclick="deleteDocument(${doc.id})" class="delete-btn">Delete</button>
                            </div>
                        </div>
                    `;
                });
                documentsList.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                const documentsList = document.getElementById('documentsList');
                documentsList.innerHTML = '<h2>Uploaded Documents</h2><p style="color: red">Error loading documents.</p>';
            });
    }

    function viewDocument(docId) {
        loader.style.display = 'block';
        results.style.display = 'none';

        fetch(`/api/documents/${docId}`)
            .then(response => response.json())
            .then(data => {
                let html = `<h2>Document: ${data.filename}</h2>`;
                
                data.pages.forEach(page => {
                    html += `
                        <div class="page">
                            <div class="page-header">Page ${page.page_number}</div>
                            <div class="page-container">
                                ${page.image_data ? 
                                    `<div>
                                        <img src="data:image/png;base64,${page.image_data}" 
                                            alt="Page ${page.page_number}" 
                                            class="page-image">
                                    </div>` : 
                                    '<div><p>No image available for this page</p></div>'
                                }
                                <div class="page-content">${page.content}</div>
                            </div>
                        </div>
                    `;
                });
                
                loader.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = html;
            })
            .catch(error => {
                loader.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = `<p style="color: red">Error loading document: ${error.message}</p>`;
            });
    }

    function deleteDocument(docId) {
        if (!confirm('Are you sure you want to delete this document?')) {
            return;
        }

        fetch(`/api/documents/${docId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(() => {
                document.getElementById(`doc-${docId}`).remove();
                if (document.querySelectorAll('.document-item').length === 0) {
                    document.getElementById('documentsList').innerHTML = '<h2>Uploaded Documents</h2><p>No documents uploaded yet.</p>';
                }
            })
            .catch(error => {
                console.error('Error deleting document:', error);
                alert('Error deleting document');
            });
    }

    function handleFile(file) {
        if (!file.type.includes('pdf')) {
            alert('Please upload a PDF file');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        loader.style.display = 'block';
        results.style.display = 'none';

        fetch('/api/process-pdf', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loader.style.display = 'none';
            results.style.display = 'block';
            
            if (data.error) {
                results.innerHTML = `<p style="color: red">Error: ${data.error}</p>`;
                return;
            }

            let html = `<h2>Extracted Content (${data.total_pages} pages)</h2>`;
            data.results.forEach(result => {
                html += `
                    <div class="page">
                        <div class="page-header">Page ${result.page_number}</div>
                        <div class="page-container">
                            ${result.image_data ? 
                                `<div>
                                    <img src="data:image/png;base64,${result.image_data}" 
                                        alt="Page ${result.page_number}" 
                                        class="page-image">
                                </div>` : 
                                '<div><p>No image available for this page</p></div>'
                            }
                            <div class="page-content">${result.content}</div>
                        </div>
                    </div>
                `;
            });
            results.innerHTML = html;
            
            // Reload the documents list after successful upload
            loadDocuments();
        })
        .catch(error => {
            loader.style.display = 'none';
            results.style.display = 'block';
            results.innerHTML = `<p style="color: red">Error: ${error.message}</p>`;
        });
    }

    // Load documents when page loads
    document.addEventListener('DOMContentLoaded', loadDocuments);
</script>
{% endblock %}
