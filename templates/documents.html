{% extends "base.html" %}

{% block title %}MedicalXtractor - Document Manager{% endblock %}

{% block nav_title %}Document Manager{% endblock %}

{% block content %}
<h1 class="page-title">Document Manager</h1>

<div class="drop-zone" id="dropZone">
    <p>Drag & Drop your medical document (PDF) here</p>
    <p>or</p>
    <p>Click to select file</p>
    <input type="file" id="fileInput" accept=".pdf" style="display: none">
</div>

<!-- Updated to use card and table design -->
<div class="card">
    <div class="card-header">
        <h2>Medical Documents</h2>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table" id="documentsTable">
                <thead>
                    <tr>
                        <th>Document Name</th>
                        <th>Upload Date</th>
                        <th>Total Pages</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="documentsTableBody">
                    <!-- Documents will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="loader" id="loader"></div>
<div id="results"></div>
{% endblock %}

{% block scripts %}
<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const loader = document.getElementById('loader');
    const results = document.getElementById('results');

    // Handle drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('dragover');
    }

    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }

    dropZone.addEventListener('drop', handleDrop, false);
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        handleFile(file);
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        handleFile(file);
    }

    function loadDocuments() {
        fetch('/api/documents')
            .then(response => response.json())
            .then(documents => {
                const documentsTableBody = document.getElementById('documentsTableBody');
                if (documents.length === 0) {
                    documentsTableBody.innerHTML = '<tr><td colspan="4">No documents uploaded yet.</td></tr>';
                    return;
                }

                let html = '';
                documents.forEach(doc => {
                    const uploadDate = new Date(doc.upload_date).toLocaleString();
                    html += `
                        <tr id="doc-${doc.id}">
                            <td>${doc.filename}</td>
                            <td>${uploadDate}</td>
                            <td>${doc.total_pages}</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewDocument(${doc.id})">View</button>
                                <button class="btn btn-danger" onclick="deleteDocument(${doc.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                documentsTableBody.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                const documentsTableBody = document.getElementById('documentsTableBody');
                documentsTableBody.innerHTML = '<tr><td colspan="4" style="color: red">Error loading documents.</td></tr>';
            });
    }

    function viewDocument(docId) {
        loader.style.display = 'block';
        results.style.display = 'none';

        fetch(`/api/documents/${docId}`)
            .then(response => response.json())
            .then(data => {
                let html = `<h2>Document: ${data.filename}</h2>`;
                
                // Sort pages by page number
                const sortedPages = data.pages.sort((a, b) => a.page_number - b.page_number);
                
                sortedPages.forEach(page => {
                    html += `
                        <div class="page">
                            <div class="page-header">Page ${page.page_number}</div>
                            <div class="page-container">
                                ${page.image_data ? 
                                    `<div>
                                        <img src="data:image/png;base64,${page.image_data}" 
                                            alt="Page ${page.page_number}" 
                                            class="page-image">
                                    </div>` : 
                                    '<div><p>No image available for this page</p></div>'
                                }
                                <div class="page-content">${page.content}</div>
                            </div>
                        </div>
                    `;
                });
                
                loader.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = html;
            })
            .catch(error => {
                loader.style.display = 'none';
                results.style.display = 'block';
                results.innerHTML = `<p style="color: red">Error loading document: ${error.message}</p>`;
            });
    }

    function deleteDocument(docId) {
        if (!confirm('Are you sure you want to delete this document?')) {
            return;
        }

        fetch(`/api/documents/${docId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(() => {
                document.getElementById(`doc-${docId}`).remove();
                if (document.querySelectorAll('tr').length === 1) { // Only header row remains
                    document.getElementById('documentsTableBody').innerHTML = '<tr><td colspan="4">No documents uploaded yet.</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error deleting document:', error);
                alert('Error deleting document');
            });
    }

    function handleFile(file) {
        if (!file.type.includes('pdf')) {
            alert('Please upload a PDF file');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        loader.style.display = 'block';
        results.style.display = 'none';
        
        // Add timeout of 5 minutes (300000ms)
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 300000);

        fetch('/api/process-pdf', {
            method: 'POST',
            body: formData,
            signal: controller.signal
        })
        .then(response => {
            if (!response.ok) {
                loader.style.display = 'none';
                results.style.display = 'block';
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            clearTimeout(timeout);
            loader.style.display = 'none';
            results.style.display = 'block';
            
            if (data.error) {
                results.innerHTML = `<p style="color: red">Error: ${data.error}</p>`;
                return;
            }

            let html = `<h2>Extracted Content (${data.total_pages} pages)</h2>`;
            data.results.forEach(result => {
                html += `
                    <div class="page">
                        <div class="page-header">Page ${result.page_number}</div>
                        <div class="page-container">
                            ${result.image_data ? 
                                `<div>
                                    <img src="data:image/png;base64,${result.image_data}" 
                                        alt="Page ${result.page_number}" 
                                        class="page-image">
                                </div>` : 
                                '<div><p>No image available for this page</p></div>'
                            }
                            <div class="page-content">${result.content}</div>
                        </div>
                    </div>
                `;
            });
            results.innerHTML = html;
            
            // Reload the documents list after successful upload
            loadDocuments();
        })
        .catch(error => {
            clearTimeout(timeout);
            loader.style.display = 'none';
            results.style.display = 'block';
            if (error.name === 'AbortError') {
                results.innerHTML = `<p style="color: red">Error: Upload timed out after 5 minutes. Please try again with a smaller file or check your connection.</p>`;
            } else {
                results.innerHTML = `<p style="color: red">Error: ${error.message}</p>`;
            }
        });
    }

    // Load documents when page loads
    document.addEventListener('DOMContentLoaded', loadDocuments);
</script>
{% endblock %}
