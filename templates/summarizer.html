{% extends "base.html" %}

{% block title %}MedicalXtractor - Medical Summarizer{% endblock %}

{% block nav_title %}Medical Summarizer{% endblock %}

{% block extra_css %}
<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1050;
}

.modal {
    position: relative;
    background: white;
    width: 90%;
    max-width: 800px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin: 20px;
}

.modal-header {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h5 {
    margin: 0;
    font-size: 1.25rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    color: #666;
}

.modal-body {
    padding: 1rem;
    max-height: 70vh;
    overflow-y: auto;
}

.modal-close:hover {
    color: #000;
}
</style>
{% endblock %}

{% block content %}
    <h1 class="page-title">Medical Summarizer</h1>
    
    <!-- NEW: Add Document button -->
    <div style="margin-bottom: 15px;">
        <button class="btn btn-success" style="margin-right: 10px;" onclick="openModal()">
            Add Document
        </button>
    </div>

    <!-- NEW: Modal for medical documents -->
    <div id="medicalDocumentsModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h5>Medical Documents</h5>
                <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table" id="unanalyzedDocumentsTable">
                        <thead>
                            <tr>
                                <th>Document Name</th>
                                <th>Upload Date</th>
                                <th>Pages</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="unanalyzedDocumentsTableBody">
                            <!-- Unanalyzed documents will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Analyzed Documents List -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>Analyzed Documents</h2>
                    <p>Documents with extracted summaries</p>
                </div>
                <button class="btn btn-primary" onclick="viewAllExtractions()">
                    View All Extractions
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table" id="analyzedDocumentsTable">
                    <thead>
                        <tr>
                            <th>Document Name</th>
                            <th>Upload Date</th>
                            <th>Pages</th>
                            <th>Extractions</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="analyzedDocumentsTableBody">
                        <!-- Analyzed documents will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Extractions View -->
    <div class="card">
        <div class="card-header">
            <h2>Medical Information Extractions</h2>
        </div>
        <div class="card-body">
            <div class="filter-row">
                <div class="row">
                    <div class="col-6">
                        <div class="button-group">
                            <button type="button" class="btn btn-filter active" data-filter="all">All Categories</button>
                            <div id="categoryFilters">
                                <!-- Category filters will be added here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-6 d-flex align-items-center justify-content-end">
                        <button type="button" class="btn btn-secondary mr-2" 
                                id="toggleTableViewBtn">Table View</button>
                        <button type="button" class="btn btn-secondary mr-3" 
                                id="toggleReportViewBtn">Report View</button>
                        <input type="text" class="search-box float-right" placeholder="Search extractions...">
                    </div>
                </div>
            </div>
            <div class="loader" id="loader"></div>
            <div class="table-responsive" id="tableView">
                <table class="table" id="extractionsTable">
                    <thead>
                        <tr>
                            <th data-sort="category">Category <i class="fas fa-sort"></i></th>
                            <th data-sort="field">Field <i class="fas fa-sort"></i></th>
                            <th data-sort="value">Value <i class="fas fa-sort"></i></th>
                            <th data-sort="associatedDate">Associated Date <i class="fas fa-sort"></i></th>
                            <th data-sort="extractionDate">Extraction Date <i class="fas fa-sort"></i></th>
                            <th data-sort="page">Page <i class="fas fa-sort"></i></th>
                            <th data-sort="documentName">Source Document <i class="fas fa-sort"></i></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="extractionsTableBody">
                        <!-- Extractions will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Report View -->
            <div id="reportView" style="display: none;">
                <!-- Categories will be dynamically added here -->
            </div>
        </div>
    </div>

<script>
    let extractionsData = [];
    let currentSort = { column: null, direction: 'asc' };
    let currentFilter = 'all';
    let currentDocumentId = null;
    let categories = new Set();
    let templateData = null; // Will store the SeekerTemplate data
    let historyData = new Map(); // Add this at the top with other let declarations
    
    // Add view mode toggle variables
    const toggleTableViewBtn = document.getElementById('toggleTableViewBtn');
    const toggleReportViewBtn = document.getElementById('toggleReportViewBtn');
    const tableView = document.getElementById('tableView');
    const reportView = document.getElementById('reportView');
    
    // Initialize view mode buttons
    toggleTableViewBtn.addEventListener('click', () => {
        tableView.style.display = 'block';
        reportView.style.display = 'none';
        toggleTableViewBtn.classList.add('active');
        toggleReportViewBtn.classList.remove('active');
        updateTable();
    });

    toggleReportViewBtn.addEventListener('click', () => {
        tableView.style.display = 'none';
        reportView.style.display = 'block';
        toggleTableViewBtn.classList.remove('active');
        toggleReportViewBtn.classList.add('active');
        updateReport();
    });
    
    // Load documents when page loads
    document.addEventListener('DOMContentLoaded', async () => {
        await loadDocuments();
        await viewAllExtractions();
    });

    function createModal(title, content) {
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'modal-overlay';
        modalOverlay.style.display = 'flex';  // Set display to flex immediately
        modalOverlay.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h5>${title}</h5>
                    <button type="button" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
            </div>
        `;
        
        document.body.appendChild(modalOverlay);
        
        const closeBtn = modalOverlay.querySelector('.modal-close');
        closeBtn.onclick = () => {
            modalOverlay.style.display = 'none';
            document.body.removeChild(modalOverlay);
        };
        
        modalOverlay.onclick = (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.style.display = 'none';
                document.body.removeChild(modalOverlay);
            }
        };
    }

    function loadDocuments() {
        fetch('/api/documents')
            .then(response => response.json())
            .then(documents => {
                const unanalyzedTableBody = document.getElementById('unanalyzedDocumentsTableBody');
                const analyzedTableBody = document.getElementById('analyzedDocumentsTableBody');
                
                if (documents.length === 0) {
                    unanalyzedTableBody.innerHTML = '<tr><td colspan="4">No documents uploaded yet.</td></tr>';
                    analyzedTableBody.innerHTML = '<tr><td colspan="5">No analyzed documents available.</td></tr>';
                    return;
                }

                // Clear existing content
                unanalyzedTableBody.innerHTML = '';
                analyzedTableBody.innerHTML = '';

                // Process each document
                documents.forEach(doc => {
                    checkSummaryStatus(doc);
                });
            })
            .catch(error => {
                console.error('Error loading documents:', error);
                document.getElementById('unanalyzedDocumentsTableBody').innerHTML = 
                    '<tr><td colspan="4" style="color: red">Error loading documents.</td></tr>';
                document.getElementById('analyzedDocumentsTableBody').innerHTML = 
                    '<tr><td colspan="5" style="color: red">Error loading documents.</td></tr>';
            });
    }

    async function checkSummaryStatus(doc) {
        try {
            const response = await fetch(`/api/analyze-summary/${doc.id}`, {
                method: 'GET'
            });
            const data = await response.json();
            const uploadDate = new Date(doc.upload_date).toLocaleString();
            
            if (response.ok && data.extractions) {
                // Document has been analyzed
                const analyzedTableBody = document.getElementById('analyzedDocumentsTableBody');
                const row = `
                    <tr>
                        <td>${doc.filename}</td>
                        <td>${uploadDate}</td>
                        <td>${doc.total_pages}</td>
                        <td>${data.extractions.length} extractions</td>
                        <td>
                            <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                                <button class="btn btn-primary" onclick="viewExtractions(${doc.id})">
                                    View Extractions
                                </button>
                                <button class="btn btn-refresh" onclick="refreshSummary(${doc.id})">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-danger" onclick="deleteSummary(${doc.id})">
                                    <i class="fas fa-trash"></i> Delete Analysis
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                analyzedTableBody.innerHTML += row;
            } else {
                // Document has not been analyzed
                const unanalyzedTableBody = document.getElementById('unanalyzedDocumentsTableBody');
                const row = `
                    <tr>
                        <td>${doc.filename}</td>
                        <td>${uploadDate}</td>
                        <td>${doc.total_pages}</td>
                        <td>
                            <button class="btn btn-success" onclick="generateSummary(${doc.id})">
                                Extract Summary
                            </button>
                        </td>
                    </tr>
                `;
                unanalyzedTableBody.innerHTML += row;
            }
        } catch (error) {
            console.error('Error checking summary status:', error);
        }
    }

    async function generateSummary(docId) {
        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        
        try {
            const response = await fetch(`/api/analyze-summary/${docId}`, {
                method: 'POST'
            });
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            // Update tables and view extractions
            loadDocuments();
            await viewExtractions(docId);
            
        } catch (error) {
            console.error('Error generating summary:', error);
            alert(`Error generating summary: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    }

    async function viewExtractions(docId) {
        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        
        try {
            const response = await fetch(`/api/analyze-summary/${docId}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            // Get document info
            const docResponse = await fetch(`/api/documents/${docId}`);
            const docData = await docResponse.json();
            
            // Update extractions data and current document ID
            extractionsData = data.extractions.filter(ext => ext.page_number != null);
            currentDocumentId = docId;
            
            // Update categories
            categories = new Set(extractionsData.map(ext => ext.category));
            updateCategoryFilters();
            
            // Update table
            updateTable();
            
        } catch (error) {
            console.error('Error viewing extractions:', error);
            alert(`Error viewing extractions: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    }

    async function refreshSummary(docId) {
        if (!confirm('Are you sure you want to refresh this summary? This will delete the current analysis and generate a new one.')) {
            return;
        }

        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        
        try {
            // Delete existing summary
            await fetch(`/api/analyze-summary/${docId}`, {
                method: 'DELETE'
            });
            
            // Generate new summary
            await generateSummary(docId);
            
        } catch (error) {
            console.error('Error refreshing summary:', error);
            alert(`Error refreshing summary: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    }

    async function deleteSummary(docId) {
        if (!confirm('Are you sure you want to delete this summary analysis? This action cannot be undone.')) {
            return;
        }

        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        
        try {
            const response = await fetch(`/api/analyze-summary/${docId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete summary');
            }

            // Clear the extractions table if we're currently viewing this document's extractions
            if (currentDocumentId === docId) {
                extractionsData = [];
                updateTable();
            }

            // Reload the documents to update the tables
            loadDocuments();
            
        } catch (error) {
            console.error('Error deleting summary:', error);
            alert(`Error deleting summary: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    }

    function updateCategoryFilters() {
        const filterContainer = document.getElementById('categoryFilters');
        filterContainer.innerHTML = Array.from(categories).map(category => `
            <button type="button" class="btn btn-filter" data-filter="${category}">
                ${category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
            </button>
        `).join('');
        
        // Add click handlers
        document.querySelectorAll('.btn-filter').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                updateTable();
            });
        });
    }

    // Function to format value for display
    function formatValue(value, field) {
        try {
            // If value is already an object, stringify it
            if (typeof value === 'object' && value !== null) {
                value = JSON.stringify(value);
            }

            // Try to parse if it's a JSON string
            let parsedValue;
            try {
                parsedValue = JSON.parse(value);
            } catch (e) {
                // If it's not JSON, return as is
                return value;
            }

            // Handle arrays
            if (Array.isArray(parsedValue)) {
                return parsedValue.map(item => {
                    if (typeof item === 'object' && item !== null) {
                        // Format each object in the array
                        return Object.entries(item)
                            .map(([key, val]) => `<div class="ml-3"><strong>${key}:</strong> ${val}</div>`)
                            .join('');
                    }
                    return `<div class="ml-3">${item}</div>`;
                }).join('');
            }

            // Handle objects
            if (typeof parsedValue === 'object' && parsedValue !== null) {
                return Object.entries(parsedValue)
                    .map(([key, val]) => `<div class="ml-3"><strong>${key}:</strong> ${val}</div>`)
                    .join('');
            }

            return value;
        } catch (e) {
            console.error('Error formatting value:', e);
            return value;
        }
    }

    function updateTable() {
        const tableBody = document.getElementById('extractionsTableBody');
        let filteredData = [...extractionsData];
        
        // Apply category filter
        if (currentFilter !== 'all') {
            filteredData = filteredData.filter(ext => ext.category === currentFilter);
        }
        
        // Apply search filter
        const searchTerm = document.querySelector('.search-box').value.toLowerCase();
        if (searchTerm) {
            filteredData = filteredData.filter(ext => 
                ext.category.toLowerCase().includes(searchTerm) ||
                ext.field.toLowerCase().includes(searchTerm) ||
                ext.value.toLowerCase().includes(searchTerm) ||
                (ext.document_name && ext.document_name.toLowerCase().includes(searchTerm))
            );
        }
        
        // Apply sorting
        if (currentSort.column) {
            filteredData.sort((a, b) => {
                let aVal = a[currentSort.column === 'associatedDate' ? 'associated_date' : 
                           currentSort.column === 'extractionDate' ? 'extraction_date' :
                           currentSort.column === 'page' ? 'page_number' :
                           currentSort.column] || '';
                let bVal = b[currentSort.column === 'associatedDate' ? 'associated_date' : 
                           currentSort.column === 'extractionDate' ? 'extraction_date' :
                           currentSort.column === 'page' ? 'page_number' :
                           currentSort.column] || '';
                
                if (currentSort.column.includes('Date')) {
                    aVal = aVal ? new Date(aVal) : new Date(0);
                    bVal = bVal ? new Date(bVal) : new Date(0);
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        // Update table content with document name
        tableBody.innerHTML = filteredData.map(ext => `
            <tr>
                <td>${ext.category}</td>
                <td>${ext.field}</td>
                <td>${formatValue(ext.value, ext.field)}</td>
                <td>${ext.associated_date || 'Not specified'}</td>
                <td>${ext.extraction_date || 'Not specified'}</td>
                <td>${ext.page_number}</td>
                <td>${ext.document_name || 'Not specified'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewPage(${ext.document_id || currentDocumentId}, ${ext.page_number})">
                        View Page
                    </button>
                </td>
            </tr>
        `).join('');
    }

    async function viewPage(documentId, pageNumber) {
        try {
            // First verify the image URL is accessible
            const response = await fetch(`/api/documents/${documentId}/pages/${pageNumber}/image`);
            if (!response.ok) {
                throw new Error('Failed to load page image');
            }
            
            const content = `
                <div style="text-align: center;">
                    <img src="/api/documents/${documentId}/pages/${pageNumber}/image" 
                         class="img-fluid" 
                         alt="Page ${pageNumber}"
                         style="max-width: 100%; height: auto;">
                </div>`;
            createModal(`Page ${pageNumber}`, content);
        } catch (error) {
            console.error('Error viewing page:', error);
            alert('Error loading page image: ' + error.message);
        }
    }

    // Add event listeners for sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
            const column = th.dataset.sort;
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update sort icons
            document.querySelectorAll('th[data-sort] i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            const icon = th.querySelector('i');
            icon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'}`;
            
            updateTable();
        });
    });

    // Add event listener for search
    document.querySelector('.search-box').addEventListener('input', () => {
        updateTable();
    });

    async function viewAllExtractions() {
        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        
        try {
            // Get all analyzed documents
            const response = await fetch('/api/documents');
            const documents = await response.json();
            
            // Initialize array to store all extractions
            let allExtractions = [];
            
            // Fetch extractions for each analyzed document
            for (const doc of documents) {
                try {
                    const extractionResponse = await fetch(`/api/analyze-summary/${doc.id}`);
                    const data = await extractionResponse.json();
                    
                    if (data.extractions) {
                        // Add document information to each extraction
                        const enhancedExtractions = data.extractions.map(ext => ({
                            ...ext,
                            document_name: doc.filename,
                            document_id: doc.id
                        }));
                        allExtractions = allExtractions.concat(enhancedExtractions);
                    }
                } catch (error) {
                    console.error(`Error fetching extractions for document ${doc.id}:`, error);
                }
            }
            
            // Filter out extractions with null page number
            allExtractions = allExtractions.filter(ext => ext.page_number != null);
            // Update extractions data and reset current document ID
            extractionsData = allExtractions;
            currentDocumentId = null;
            
            // Update categories
            categories = new Set(extractionsData.map(ext => ext.category));
            updateCategoryFilters();
            
            // Update table
            updateTable();
            
        } catch (error) {
            console.error('Error viewing all extractions:', error);
            alert(`Error viewing all extractions: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    }

    // NEW: openModal and closeModal functions
    function openModal() {
        const modal = document.getElementById('medicalDocumentsModal');
        modal.style.display = 'flex';  // Use flex instead of block
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        const modal = document.getElementById('medicalDocumentsModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Function to safely store and retrieve history data
    function storeHistoryData(fieldName, values) {
        const key = `${fieldName}_${Date.now()}`;
        historyData.set(key, values);
        return key;
    }

    function getHistoryData(key) {
        return historyData.get(key);
    }

    // Update the report view's button generation
    async function updateReport() {
        if (!templateData) {
            // Fetch template data if not already loaded
            try {
                const response = await fetch('/api/seeker-template');
                if (!response.ok) {
                    throw new Error('Failed to load template data');
                }
                templateData = await response.json();
            } catch (error) {
                console.error('Error loading template:', error);
                alert('Error loading report template. Please try again.');
                return;
            }
        }

        const reportContainer = document.getElementById('reportView');
        reportContainer.innerHTML = ''; // Clear existing content

        // Process each category
        for (const [categoryKey, categoryData] of Object.entries(templateData)) {
            const categoryElement = document.createElement('div');
            categoryElement.className = 'card mb-4';
            
            // Create category header
            categoryElement.innerHTML = `
                <div class="card-header">
                    <h3>${categoryKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        ${categoryData.fields.map(field => {
                            const values = getLatestValues(categoryKey, field.Field);
                            const latestValue = values[0];
                            const showHistory = categoryData.report_style === 'history';
                            const displayValues = showHistory ? values.slice(0, 3) : [latestValue];
                            const historyKey = storeHistoryData(field.Field, values);
                            
                            return `
                                <div class="col-12 mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <strong>${field.Field}:</strong>
                                            ${!values.length ? 
                                                '<span class="text-muted">No data available</span>' :
                                                displayValues.map(v => `
                                                    <div class="mt-2">
                                                        <div>${formatValue(v.value, field.Field)}</div>
                                                        ${v.associated_date ? 
                                                            `<small class="text-muted">(${v.associated_date})</small>` : 
                                                            ''}
                                                    </div>
                                                `).join('<hr class="my-2">')
                                            }
                                        </div>
                                        ${values.length > (showHistory ? 3 : 1) ? `
                                            <button class="btn btn-sm btn-outline-primary ml-3"
                                                    onclick="showHistory('${field.Field}', '${historyKey}')">
                                                View History
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            reportContainer.appendChild(categoryElement);
        }
    }

    // New function to show history
    function showHistory(fieldName, historyKey) {
        const values = getHistoryData(historyKey);
        if (!values) {
            console.error('History data not found');
            return;
        }
        createHistoryModal(fieldName, values);
    }

    // Update the createHistoryModal function to handle the data safely
    function createHistoryModal(fieldName, values) {
        const modalContent = `
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Value</th>
                            <th>Date</th>
                            <th>Source</th>
                            <th>Page</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${values.map(v => `
                            <tr>
                                <td>${formatValue(v.value, fieldName)}</td>
                                <td>${v.associated_date || 'Not specified'}</td>
                                <td>${v.document_name || 'Not specified'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="viewPage(${v.document_id}, ${v.page_number})">
                                        View Page
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        createModal(`History for ${fieldName}`, modalContent);
    }

    // Function to get latest values for a field
    function getLatestValues(category, field, limit = null) {
        const values = extractionsData
            .filter(ext => ext.category === category && ext.field === field)
            .sort((a, b) => {
                const dateA = a.associated_date ? new Date(a.associated_date) : new Date(0);
                const dateB = b.associated_date ? new Date(b.associated_date) : new Date(0);
                return dateB - dateA;
            });
        
        return limit ? values.slice(0, limit) : values;
    }
</script>
{% endblock %} 